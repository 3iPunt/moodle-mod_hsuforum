YUI.add("moodle-mod_hsuforum-article",function(e,t){function i(){i.superclass.constructor.apply(this,arguments)}function o(){o.superclass.constructor.apply(this,arguments)}function u(){u.superclass.constructor.apply(this,arguments)}var n={DISCUSSION_VIEW:".hsuforum-thread-view",CONTAINER:".mod_hsuforum_posts_container",LOAD_MORE:".hsuforum-threads-load-more",LOAD_TARGET:".hsuforum-threads-load-target",ADD_DISCUSSION_TARGET:".hsuforum-add-discussion-target",DISCUSSIONS:".hsuforum-threads-wrapper",DISCUSSION:".hsuforum-thread-article",DISCUSSION_COUNT:".hsuforum-thread-count",DISCUSSION_CLOSE:".hsuforum-thread-nav .close",DISCUSSION_NEXT:".hsuforum-thread-nav .next",DISCUSSION_PREV:".hsuforum-thread-nav .prev",DISCUSSION_NAV_LINKS:".hsuforum-thread-nav a",POST_TARGET:".hsuforum-post-target",POST_BY_ID:'.hsuforum-post-target[data-postid="%d"]',DISCUSSION_BY_ID:'.hsuforum-thread-article[data-discussionid="%d"]',POSTS:".hsuforum-thread-replies",PLACEHOLDER:".thread-replies-placeholder",VIEW_POSTS:".hsuforum-view-posts",REPLY_TEMPLATE:"#hsuforum-reply-template",DISCUSSION_TEMPLATE:"#hsuforum-discussion-template",ALL_FORMS:".hsuforum-reply-wrapper form",FORM_REPLY:".hsuforum-reply",FORM_REPLY_WRAPPER:".hsuforum-reply-wrapper",FORM_DISCUSSION:".hsuforum-discussion",VALIDATION_ERRORS:".hsuforum-validation-errors",FORM_ADVANCED:".hsuforum-use-advanced",INPUT_REPLY:'input[name="reply"]',INPUT_MESSAGE:'textarea[name="message"]',INPUT_SUBJECT:'input[name="subject"]',INPUT_FORUM:'input[name="forum"]',ADD_DISCUSSION:"#newdiscussionform",ADD_DISCUSSION_BUTTON:'#newdiscussionform input[type="submit"]',NOTIFICATION:".hsuforum-notification",OPTIONS_TO_PROCESS:".hsuforum-options-menu.unprocessed",RATE_POPUP:".forum-post-rating a",RATE:".forum-post-rating",SEARCH_PAGE:"#page-mod-hsuforum-search"},r={POST_CREATED:"post:created",POST_DELETE:"post:delete",POST_DELETED:"post:deleted",DISCUSSION_CREATED:"discussion:created"};M.mod_hsuforum=M.mod_hsuforum||{},i.NAME="moodle-mod_hsuforum-dom",i.ATTRS={io:{value:null}},e.extend(i,e.Base,{initializer:function(){e.all(n.RATE).addClass("processed"),this.initOptionMenus()},initFeatures:function(){this.initOptionMenus(),this.initRatings()},initRatings:function(){e.all(n.RATE).each(function(t){if(t.hasClass("processed"))return;M.core_rating.Y=e,t.all("select.postratingmenu").each(M.core_rating.attach_rating_events,M.core_rating),t.all("input.postratingmenusubmit").setStyle("display","none"),t.addClass("processed")})},initOptionMenus:function(){e.all(n.OPTIONS_TO_PROCESS).each(function(t){t.removeClass("unprocessed");var r=new e.YUI2.widget.Menu(t.generateID(),{lazyLoad:!0});r.render(e.one(n.CONTAINER).generateID()),e.one("#"+t.getData("controller")).on("click",function(e){e.preventDefault(),r.cfg.setProperty("y",e.currentTarget.getY()+e.currentTarget.get("offsetHeight")),r.cfg.setProperty("x",e.currentTarget.getX()),r.show()})})},handleViewRating:function(e){if(e.currentTarget.ancestor(".helplink")!==null)return;e.preventDefault(),openpopup(e,{url:e.currentTarget.get("href")+"&popup=1",name:"ratings",options:"height=400,width=600,top=0,left=0,menubar=0,location=0,scrollbars,resizable,toolbar,status,directories=0,fullscreen=0,dependent"})},markPostAsRead:function(e,t,n){this.get("io").send({postid:e,action:"markread"},t,n)},ensurePostsExist:function(e,t,r){var i=e.hasAttribute("data-isunread");i&&e.removeAttribute("data-isunread");var s=e.one(n.PLACEHOLDER);if(s===null){this.initFeatures(),i?this.markPostAsRead(e.getData("postid"),t,r):t.call(r);return}this.get("io").send({discussionid:e.getData("discussionid"),action:"posts_html"},function(e){s.replace(e.html),this.initFeatures(),t.call(r)},this)},displayNotification:function(t){var r=e.Node.create(t);e.one(n.NOTIFICATION).append(r),setTimeout(function(){r.remove(!0)},1e4)},handlePostCreated:function(t){var r=e.one(n.DISCUSSION_BY_ID.replace("%d",t.discussionid));r.replace(t.html)},handleDiscussionCreated:function(t){this.displayNotification(t.notificationhtml);var r=e.one(n.DISCUSSION_COUNT);r!==null&&(r.setData("count",parseInt(r.getData("count"),10)+1),r.setHTML(M.util.get_string("xdiscussions","mod_hsuforum",r.getData("count")))),e.one(n.ADD_DISCUSSION_BUTTON).focus()},handlePostDelete:function(t){var i=e.one(n.POST_BY_ID.replace("%d",t.postid));if(i===null)return;this.get("io").send({postid:t.postid,sesskey:M.cfg.sesskey,action:"delete_post"},function(t){if(i.hasAttribute("data-isdiscussion"))window.location.href=t.redirecturl;else{var s=e.one(n.DISCUSSION_BY_ID.replace("%d",i.getData("discussionid")));s.replace(t.html),this.fire(r.POST_DELETED,t)}},this)},loadMoreDiscussions:function(t,r,i,s){var o=e.one(n.LOAD_TARGET);if(!(o instanceof e.Node))return;this.get("io").send({page:t,perpage:r,action:"discussions_html"},function(e){o.insert(e.html,"before"),i.call(s)},this)}}),M.mod_hsuforum.Dom=i;var s=e.Base.create("hsuforumRouter",e.Router,[],{initializer:function(){e.one(n.DISCUSSIONS)===null&&e.all(n.DISCUSSION_NAV_LINKS).addClass("disable-router")},view:function(t){this.get("article").collapseAllDiscussions(),e.Lang.isUndefined(t.query.page)?this.get("article").loadPage(0):this.get("article").loadPage(parseInt(t.query.page,10))},discussion:function(e){this.get("article").viewDiscussion(e.query.d,e.query.postid)},post:function(t){if(!e.Lang.isUndefined(t.query.reply))this.get("article").get("form").showReplyToForm(t.query.reply);else if(!e.Lang.isUndefined(t.query.forum))this.get("article").get("form").showAddDiscussionForm(t.query.forum);else if(!e.Lang.isUndefined(t.query["delete"]))this.get("article").confirmDelete(t.query["delete"]);else if(!e.Lang.isUndefined(t.query.edit)||!e.Lang.isUndefined(t.query.prune))window.location.href=M.cfg.wwwroot+this.get("root")+t.path+"?"+e.QueryString.stringify(t.query)},handleRoute:function(e){if(e.button!==1||e.ctrlKey||e.metaKey||e.currentTarget.hasClass("disable-router"))return;this.routeUrl(e.currentTarget.get("href"))&&e.preventDefault()},routeUrl:function(e){var t=this.removeRoot
(e);return this.hasRoute(t)?(this.save(t),!0):!1},handleAddDiscussionRoute:function(e){e.preventDefault();var t=e.currentTarget,r=this.removeRoot(t.get("action")),i=t.one(n.INPUT_FORUM).get("value");this.save(r+"?forum="+i)},handleViewDiscussion:function(t){var n="/discuss.php?d="+t.discussionid;e.Lang.isUndefined(t.postid)||(n=n+"&postid="+t.postid),this.save(n)},hideForms:function(e,t,n){this.get("article").get("form").removeAllForms(),n()}},{ATTRS:{article:{value:null},root:{value:"/mod/hsuforum"},routes:{value:[{path:"/view.php",callbacks:["hideForms","view"]},{path:"/discuss.php",callbacks:["hideForms","discussion"]},{path:"/post.php",callbacks:["hideForms","post"]}]}}});M.mod_hsuforum.Router=s,o.NAME="moodle-mod_hsuforum-form",o.ATTRS={io:{value:null}},e.extend(o,e.Base,{_displayReplyForm:function(t){var r=e.one(n.REPLY_TEMPLATE).getHTML(),i=t.one(n.FORM_REPLY_WRAPPER);i instanceof e.Node?i.replace(r):t.append(r),i=t.one(n.FORM_REPLY_WRAPPER),this.attachFormWarnings(),i.one(n.INPUT_REPLY).setAttribute("value",t.getData("postid"));var s=i.one(n.FORM_ADVANCED);s.setAttribute("href",s.getAttribute("href").replace(/reply=\d+/,"reply="+t.getData("postid"))),t.hasAttribute("data-ispost")&&i.one("legend").setHTML(M.util.get_string("replytox","mod_hsuforum",t.getData("author")))},_submitReplyForm:function(e,t){e.all("button").setAttribute("disabled","disabled"),this.get("io").submitForm(e.one("form"),function(r){r.errors===!0?(e.one(n.VALIDATION_ERRORS).setHTML(r.html).addClass("notifyproblem"),e.all("button").removeAttribute("disabled")):t.call(this,r)},this,!0)},attachFormWarnings:function(){e.all(n.ALL_FORMS).each(function(e){e.hasClass("form-checker-added")||(M.core_formchangechecker.init({formid:e.generateID()}),e.addClass("form-checker-added"))})},removeAllForms:function(){e.all(n.POSTS+" "+n.FORM_REPLY).remove(!0);var t=e.one(n.ADD_DISCUSSION_TARGET);t!==null&&t.empty()},showReplyToForm:function(t){var r=e.one(n.POST_BY_ID.replace("%d",t));r.hasAttribute("data-ispost")&&this._displayReplyForm(r),r.one(n.INPUT_MESSAGE).focus()},handleSubmitReplyTo:function(e){e.preventDefault();var t=e.currentTarget.ancestor(n.POST_TARGET),i=t.one(n.FORM_REPLY_WRAPPER);this._submitReplyForm(i,function(e){this.fire(r.POST_CREATED,e),t.hasAttribute("data-isdiscussion")&&this._displayReplyForm(t)})},showAddDiscussionForm:function(){e.one(n.ADD_DISCUSSION_TARGET).setHTML(e.one(n.DISCUSSION_TEMPLATE).getHTML()).one(n.INPUT_SUBJECT).focus(),this.attachFormWarnings()},handleSubmitAddDiscussion:function(e){e.preventDefault();var t=e.currentTarget.ancestor(n.FORM_REPLY_WRAPPER);this._submitReplyForm(t,function(e){this.removeAllForms(),this.fire(r.DISCUSSION_CREATED,e)})}}),M.mod_hsuforum.Form=o,u.NAME=t,u.ATTRS={contextId:{value:undefined},io:{readOnly:!0},dom:{readOnly:!0},router:{readOnly:!0},form:{readOnly:!0},liveLog:{readOnly:!0}},e.extend(u,e.Base,{initializer:function(){this._set("router",new M.mod_hsuforum.Router({article:this,html5:!1})),this._set("io",new M.mod_hsuforum.Io({contextId:this.get("contextId")})),this._set("dom",new M.mod_hsuforum.Dom({io:this.get("io")})),this._set("form",new M.mod_hsuforum.Form({io:this.get("io")})),this._set("liveLog",M.mod_hsuforum.init_livelog()),this.bind()},bind:function(){if(e.one(n.SEARCH_PAGE)!==null)return;var t=e.one(n.CONTAINER);if(t===null)return;var i=this.get("dom"),s=this.get("form"),o=this.get("router");t.delegate("click",this.handleViewNextDiscussion,n.DISCUSSION_NEXT,this),t.delegate("click",o.handleRoute,"a",o),t.delegate("submit",s.handleSubmitReplyTo,n.FORM_REPLY,s),t.delegate("submit",s.handleSubmitAddDiscussion,n.FORM_DISCUSSION,s),t.delegate("click",i.handleViewRating,n.RATE_POPUP,i),t.delegate("click",function(e){e.target.ancestor(n.DISCUSSION).focus(),this.get("liveLog").logText(M.str.mod_hsuforum.discussionclosed)},n.DISCUSSION_CLOSE,this);var u=e.one(n.ADD_DISCUSSION);u instanceof e.Node&&u.on("submit",o.handleAddDiscussionRoute,o),s.on(r.POST_CREATED,i.handlePostCreated,i),s.on(r.POST_CREATED,o.handleViewDiscussion,o),s.on(r.DISCUSSION_CREATED,i.handleDiscussionCreated,i),this.on(r.POST_DELETE,i.handlePostDelete,i),i.on(r.POST_DELETED,o.handleViewDiscussion,o),s.on(r.DISCUSSION_CREATED,this.handleLiveLog,this),s.on(r.POST_CREATED,this.handleLiveLog,this),i.on(r.POST_DELETED,this.handleLiveLog,this),t.delegate("click",function(){this.get("liveLog").logText(M.str.mod_hsuforum.discussionloaded)},[n.DISCUSSION_VIEW,n.DISCUSSION_NEXT,n.DISCUSSION_PREV].join(", "),this)},handleLiveLog:function(t){e.Lang.isString(t.livelog)&&this.get("liveLog").logText(t.livelog)},viewDiscussion:function(t,r){var i=e.one(n.DISCUSSION_BY_ID.replace("%d",t));if(!(i instanceof e.Node))return;this.get("dom").ensurePostsExist(i,function(){this.collapseAllDiscussions(),this.expandDiscussion(i);if(!e.Lang.isUndefined(r)){var t=e.one(n.POST_BY_ID.replace("%d",r));t===null||t.hasAttribute("data-isdiscussion")?i.focus():t.get("parentNode").focus()}else i.focus()},this)},handleViewNextDiscussion:function(t){var r=t.currentTarget.ancestor(n.DISCUSSION);if(!r.next().test(n.DISCUSSION)&&this.canLoadMoreDiscussions()){var i=e.one(n.LOAD_MORE);if(i===null)return;t.preventDefault(),t.stopImmediatePropagation();var s=e.QueryString.parse(i.get("href").split("?")[1]);this.loadPage(s.page,function(){this.get("router").routeUrl(t.currentTarget.get("href"))},this)}},loadPage:function(t,r,i){var s=e.one(n.LOAD_MORE);if(s===null)return;var o=e.all(n.DISCUSSION),u=parseInt(s.getData("total"),10),a=parseInt(s.getData("perpage"),10),f=t*a+a;f>u&&(f=u);if(f>o.size()){var l=Math.ceil((f-o.size())/a);l--,l>=0&&this._loadAllPages(t,a,l,function(){var o=s.getAttribute("href").replace(/page=\d+/,"page="+(t+1));s.setAttribute("href",o),f>=u?s.hide():s.show(),e.all(n.DISCUSSION).item(f-a).focus(),r&&r.call(i)},this)}else r&&r.call(i)},_loadAllPages:function(e,t,n,r,i){this.get("dom").loadMoreDiscussions(e-n,t,function(){var s=n-1;s>=0?this._loadAllPages(e,t,s,r,i):r.call(i)},this)},expandDiscussion:function(
t){var r=e.one(n.CONTAINER).all(n.DISCUSSION);r.each(function(e){e.setAttribute("aria-hidden","true")}),t.setAttribute("aria-hidden","false"),t.addClass("hsuforum-thread-article-expanded"),this.get("form").attachFormWarnings()},collapseAllDiscussions:function(){var t=e.one(n.CONTAINER).all(n.DISCUSSION);t.each(function(e){e.removeClass("hsuforum-thread-article-expanded"),e.setAttribute("aria-hidden","false")})},canLoadMoreDiscussions:function(){var t=e.one(n.LOAD_MORE);return t===null?!1:t.getStyle("display")!=="none"},confirmDelete:function(t){var i=e.one(n.POST_BY_ID.replace("%d",t));if(i===null)return;window.confirm(M.str.mod_hsuforum.deletesure)===!0&&this.fire(r.POST_DELETE,{postid:t})}}),M.mod_hsuforum.Article=u,M.mod_hsuforum.init_article=function(e){new u(e)}},"@VERSION@",{requires:["base","node","event","router","yui2-menu","core_rating","querystring","moodle-mod_hsuforum-io","moodle-mod_hsuforum-livelog","moodle-core-formchangechecker"]});
